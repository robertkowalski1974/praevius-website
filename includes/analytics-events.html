<!-- Praevius Analytics Event Tracking -->
<script>
// Initialize dataLayer if not already present
window.dataLayer = window.dataLayer || [];

// ============================================
// HELPER FUNCTIONS
// ============================================

/**
 * Push event to dataLayer
 * @param {string} eventName - The event name
 * @param {object} eventParams - Additional event parameters
 */
function trackEvent(eventName, eventParams = {}) {
  const baseParams = {
    'event': eventName,
    'page_url': window.location.href,
    'page_path': window.location.pathname,
    'timestamp': new Date().toISOString()
  };

  window.dataLayer.push({...baseParams, ...eventParams});
}

// ============================================
// PAGE-SPECIFIC TRACKING
// ============================================

// Track pricing page views
if (window.location.pathname.includes('/pricing')) {
  trackEvent('view_pricing', {
    'page_section': 'pricing',
    'referrer': document.referrer
  });
}

// Track feature page engagement
if (window.location.pathname.includes('/features')) {
  trackEvent('view_features', {
    'page_section': 'features'
  });
}

// ============================================
// CTA BUTTON TRACKING
// ============================================

document.addEventListener('DOMContentLoaded', function() {

  // Track all CTA buttons with specific classes
  const ctaButtons = document.querySelectorAll('.cta-button, .btn-primary, [class*="cta"]');

  ctaButtons.forEach(function(button) {
    button.addEventListener('click', function(e) {
      const buttonText = this.textContent.trim();
      const buttonHref = this.getAttribute('href') || '';
      const buttonLocation = getButtonLocation(this);

      // Determine event type based on button text/href
      let eventName = 'cta_click';
      let eventParams = {
        'cta_text': buttonText,
        'cta_url': buttonHref,
        'cta_location': buttonLocation
      };

      // Specific tracking for trial buttons
      if (buttonText.toLowerCase().includes('free trial') ||
          buttonText.toLowerCase().includes('start trial') ||
          buttonHref.includes('start-trial')) {
        eventName = 'free_trial_click';

        // Try to detect plan interest from URL or context
        if (buttonHref.includes('essential')) {
          eventParams.plan_interest = 'essential';
        } else if (buttonHref.includes('professional')) {
          eventParams.plan_interest = 'professional';
        } else if (buttonHref.includes('scale')) {
          eventParams.plan_interest = 'scale';
        }
      }

      // Demo request tracking
      if (buttonText.toLowerCase().includes('demo') ||
          buttonText.toLowerCase().includes('book')) {
        eventName = 'demo_request_click';
      }

      // Contact tracking
      if (buttonText.toLowerCase().includes('contact') ||
          buttonHref.includes('/contact')) {
        eventName = 'contact_click';
      }

      trackEvent(eventName, eventParams);
    });
  });

  // ============================================
  // PRICING CARD INTERACTIONS
  // ============================================

  const pricingCards = document.querySelectorAll('.pricing-card, [class*="pricing"]');

  pricingCards.forEach(function(card) {
    card.addEventListener('click', function(e) {
      // Get plan name from card
      const planName = getPlanFromCard(this);
      if (planName) {
        trackEvent('pricing_card_click', {
          'plan_name': planName
        });
      }
    });
  });

  // ============================================
  // FORM TRACKING
  // ============================================

  const forms = document.querySelectorAll('form');

  forms.forEach(function(form) {
    // Track form start (first interaction)
    let formStarted = false;
    form.addEventListener('focusin', function(e) {
      if (!formStarted) {
        formStarted = true;
        const formType = getFormType(this);
        trackEvent(formType + '_started', {
          'form_id': this.id || 'unknown',
          'form_location': getButtonLocation(this)
        });
      }
    });

    // Track form submission
    form.addEventListener('submit', function(e) {
      const formType = getFormType(this);
      trackEvent(formType + '_submitted', {
        'form_id': this.id || 'unknown',
        'form_location': getButtonLocation(this)
      });
    });
  });

  // ============================================
  // SCROLL DEPTH TRACKING
  // ============================================

  let scrollDepths = [25, 50, 75, 90];
  let scrolledDepths = [];

  window.addEventListener('scroll', function() {
    const scrollPercent = Math.round(
      (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100
    );

    scrollDepths.forEach(function(depth) {
      if (scrollPercent >= depth && !scrolledDepths.includes(depth)) {
        scrolledDepths.push(depth);
        trackEvent('scroll_depth', {
          'scroll_percentage': depth
        });
      }
    });
  });

  // ============================================
  // EXTERNAL LINK TRACKING
  // ============================================

  const externalLinks = document.querySelectorAll('a[href^="http"]:not([href*="praevius.app"])');

  externalLinks.forEach(function(link) {
    link.addEventListener('click', function(e) {
      trackEvent('outbound_link_click', {
        'link_url': this.href,
        'link_text': this.textContent.trim()
      });
    });
  });

});

// ============================================
// HELPER FUNCTIONS
// ============================================

/**
 * Determine button location on page
 */
function getButtonLocation(element) {
  // Check if in navbar
  if (element.closest('nav, .navbar, header')) {
    return 'navbar';
  }
  // Check if in hero section
  if (element.closest('.hero, [class*="hero"]')) {
    return 'hero';
  }
  // Check if in footer
  if (element.closest('footer, .footer')) {
    return 'footer';
  }
  // Check if in pricing section
  if (element.closest('[class*="pricing"]')) {
    return 'pricing_section';
  }
  // Default to body
  return 'body';
}

/**
 * Get plan name from pricing card
 */
function getPlanFromCard(card) {
  const text = card.textContent.toLowerCase();
  if (text.includes('essential') || text.includes('79')) {
    return 'essential';
  } else if (text.includes('professional') || text.includes('179')) {
    return 'professional';
  } else if (text.includes('scale') || text.includes('349')) {
    return 'scale';
  }
  return null;
}

/**
 * Determine form type
 */
function getFormType(form) {
  const formId = (form.id || '').toLowerCase();
  const formClass = (form.className || '').toLowerCase();
  const pageUrl = window.location.pathname.toLowerCase();

  if (formId.includes('demo') || formClass.includes('demo')) {
    return 'demo_request';
  }
  if (formId.includes('contact') || formClass.includes('contact') || pageUrl.includes('contact')) {
    return 'contact_form';
  }
  if (formId.includes('newsletter') || formClass.includes('newsletter')) {
    return 'newsletter_signup';
  }
  return 'form';
}

// ============================================
// PIPEDRIVE LEADBOOSTER INTEGRATION
// ============================================

// Track Pipedrive chatbot interactions (if available)
if (window.LeadBooster) {
  // Track when chat is opened
  window.LeadBooster.on('open', function() {
    trackEvent('chatbot_opened', {
      'chatbot_type': 'pipedrive_leadbooster'
    });
  });

  // Track when chat is closed
  window.LeadBooster.on('close', function() {
    trackEvent('chatbot_closed', {
      'chatbot_type': 'pipedrive_leadbooster'
    });
  });
}

console.log('Praevius Analytics: Event tracking initialized');
</script>
